{% extends "base.html" %}
{% block title %}Import Flights{% endblock %}

{% block content %}
<div class="form-card">
    <h1>Import Flights from CSV ðŸ“¤</h1>
    <p>Upload a CSV file with columns: <code>origin</code>, <code>destination</code>, and <code>date</code>.</p>
    <form class="add-form" id="import-form">
        <input type="file" name="file" id="file-input" accept=".csv" required hidden>
        <md-outlined-button type="button" id="select-file-btn">Choose File</md-outlined-button>
        <span id="file-name-display">No file chosen</span>
        <div class="form-actions">
            <md-filled-button type="submit" id="submit-btn">Upload and Import</md-filled-button>
            <md-circular-progress indeterminate id="import-loader" style="display: none;"></md-circular-progress>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
<script>
    const fileInput = document.getElementById('file-input');
    const selectFileBtn = document.getElementById('select-file-btn');
    const fileNameDisplay = document.getElementById('file-name-display');
    const importForm = document.getElementById('import-form');
    const submitBtn = document.getElementById('submit-btn');
    const loader = document.getElementById('import-loader');

    selectFileBtn.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', () => {
        fileNameDisplay.textContent = fileInput.files.length > 0 ? fileInput.files[0].name : 'No file chosen';
    });

    importForm.addEventListener('submit', (event) => {
        event.preventDefault();
        const file = fileInput.files[0];
        if (!file) {
            alert('Please select a file to import.');
            return;
        }

        // Show loading state
        submitBtn.disabled = true;
        loader.style.display = 'flex';
        submitBtn.textContent = 'Importing...';

        // Use Papa Parse to read the file
        Papa.parse(file, {
            header: true,
            skipEmptyLines: true,
            complete: async (results) => {
                const flightsToImport = results.data.map(row => ({
                    origin: row.origin ? row.origin.toUpperCase() : '',
                    destination: row.destination ? row.destination.toUpperCase() : '',
                    date: row.date
                }));
                
                await importFlights(flightsToImport);
                alert(`${flightsToImport.length} flights imported successfully!`);
                window.location.href = "{{ url_for('view_flights') }}";
            },
            error: (error) => {
                console.error("CSV parsing error:", error);
                alert("An error occurred while parsing the CSV file.");
                // Reset button state
                submitBtn.disabled = false;
                loader.style.display = 'none';
                submitBtn.textContent = 'Upload and Import';
            }
        });
    });
</script>
{% endblock %}