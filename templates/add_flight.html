{% extends "base.html" %}
{% block title %}Add a New Flight{% endblock %}

{% block content %}
<div class="form-card">
    <h1>Add a New Flight</h1>
    <form class="add-form" id="add-form">
        <div class="input-row">
            <div class="input-group">
                <label for="origin-input">Origin</label>
                <input class="styled-input" type="text" id="origin-input" list="airport-list" placeholder="Type a city or code" required>
            </div>
            <div class="input-group">
                <label for="destination-input">Destination</label>
                <input class="styled-input" type="text" id="destination-input" list="airport-list" placeholder="Type a city or code" required>
            </div>
        </div>
    
        <datalist id="airport-list"></datalist>
        
        <md-outlined-text-field label="Date" type="date" name="date" required></md-outlined-text-field>
    
        <div class="form-actions">
            <md-filled-button type="submit">Add Flight</md-filled-button>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Populate the datalist with suggestions ---
        const airportDataString = localStorage.getItem('airportData');
        if (airportDataString) {
            const airportData = new Map(JSON.parse(airportDataString));
            const datalist = document.getElementById('airport-list');
            
            for (const [iata, data] of airportData.entries()) {
                const option = document.createElement('option');
                option.value = iata; // The value when selected is the IATA code
                // The visible text is more descriptive
                option.textContent = `${data.city || data.name}, ${data.country} (${iata})`;
                datalist.appendChild(option);
            }
        }

        // --- Handle form submission ---
        const addForm = document.getElementById('add-form');
        addForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const originIata = document.getElementById('origin-input').value.toUpperCase();
            const destinationIata = document.getElementById('destination-input').value.toUpperCase();

            const newFlight = {
                origin: originIata,
                destination: destinationIata,
                date: addForm.date.value
            };
            
            await addFlight(newFlight);
            window.location.href = "{{ url_for('view_flights') }}";
        });
    });
</script>
{% endblock %}