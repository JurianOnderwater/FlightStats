{% extends "base.html" %}
{% block title %}Edit Flight{% endblock %}

{% block content %}
<div class="form-card">
    <h1>Edit Flight ✏️</h1>
    <form class="add-form" id="edit-form">
        <div class="input-row">
            <div class="input-group">
                <label for="origin-input">Origin</label>
                <input class="styled-input" type="text" id="origin-input" list="airport-list" required>
            </div>
            <div class="input-group">
                <label for="destination-input">Destination</label>
                <input class="styled-input" type="text" id="destination-input" list="airport-list" required>
            </div>
        </div>

        <datalist id="airport-list"></datalist>

        <md-outlined-text-field label="Date" name="date" type="date" required></md-outlined-text-field>
    </form>
    <div class="form-actions">
        <md-icon-button class="delete-btn" id="delete-btn">
            <span class="material-symbols-outlined">delete</span>
        </md-icon-button>
        <div class="save-actions">
            <a href="{{ url_for('view_flights') }}"><md-text-button>Cancel</md-text-button></a>
            <md-filled-button type="submit" form="edit-form">Save Changes</md-filled-button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', async () => {
        const flightId = parseInt('{{ flight_id }}', 10);
        const form = document.getElementById('edit-form');
        const deleteBtn = document.getElementById('delete-btn');
        const originInput = document.getElementById('origin-input');
        const destinationInput = document.getElementById('destination-input');

        // --- 1. Populate the datalist with suggestions ---
        const airportDataString = localStorage.getItem('airportData');
        if (airportDataString) {
            const airportData = new Map(JSON.parse(airportDataString));
            const datalist = document.getElementById('airport-list');
            
            for (const [iata, data] of airportData.entries()) {
                const option = document.createElement('option');
                option.value = iata;
                option.textContent = `${data.city || data.name}, ${data.country} (${iata})`;
                datalist.appendChild(option);
            }
        }

        // --- 2. Fetch the current flight and populate the form ---
        const flight = await getFlight(flightId);
        if (flight) {
            originInput.value = flight.origin;
            destinationInput.value = flight.destination;
            form.date.value = flight.date;
        }

        // --- 3. Handle form submission for saving changes ---
        form.addEventListener('submit', async (event) => {
            event.preventDefault();
            const updatedFlight = {
                id: flightId,
                origin: originInput.value.toUpperCase(),
                destination: destinationInput.value.toUpperCase(),
                date: form.date.value
            };
            await updateFlight(updatedFlight);
            window.location.href = "{{ url_for('view_flights') }}";
        });

        // --- 4. Handle the delete button click ---
        deleteBtn.addEventListener('click', async () => {
            if (confirm('Are you sure you want to delete this flight?')) {
                await deleteFlight(flightId);
                window.location.href = "{{ url_for('view_flights') }}";
            }
        });
    });
</script>
{% endblock %}