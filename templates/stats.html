{% extends "base.html" %}
{% block title %}Statistics{% endblock %}

{% block content %}
    <div class="hero-stats">
        <div class="hero-stat-item">
            <span id="hero-flights" class="hero-stat-number">0</span>
            <p class="hero-stat-label">Flights</p>
        </div>
        <div class="hero-stat-item">
            <span id="hero-countries" class="hero-stat-number">0</span>
            <p class="hero-stat-label">Countries</p>
        </div>
        <div class="hero-stat-item">
            <span id="hero-airports" class="hero-stat-number">0</span>
            <p class="hero-stat-label">Airports</p>
        </div>
        <div class="hero-stat-item">
            <span id="hero-routes" class="hero-stat-number">0</span>
            <p class="hero-stat-label">Routes</p>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stats-card">
            <h2>Distance üåç</h2>
            <p><strong>Total Kilometres:</strong> <span id="total-km">0</span> km</p>
            <p><strong>Total Miles:</strong> <span id="total-miles">0</span> mi</p>
            <p><strong>Earth Circumnavigations:</strong> <span id="earth-circumnavigations">0</span></p>
            <p><strong>Journey to the Moon:</strong> <span id="percent-to-moon">0</span>%</p>
        </div>
        <div class="stats-card">
            <h2>Time (Estimated) ‚è±Ô∏è</h2>
            <p><strong>Total Hours Flown:</strong> <span id="total-hours">0</span></p>
            <p><strong>Total Days Flown:</strong> <span id="total-days">0</span></p>
            <p><strong>Total Weeks Flown:</strong> <span id="total-weeks">0</span></p>
            <p><strong>Total Months Flown:</strong> <span id="total-months">0</span></p>
        </div>
        <div class="stats-card">
            <h2>Top 10 Airports üèÜ</h2>
            <ol id="top-airports-list" class="stats-list"></ol>
        </div>
        <div class="stats-card">
            <h2>Top 10 Routes ‚úàÔ∏è</h2>
            <ol id="top-routes-list" class="stats-list"></ol>
        </div>
        <div class="stats-card">
            <h2>Distance Milestones üèÅ</h2>
            <ul id="milestones-list" class="stats-list">
                </ul>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="{{ url_for('static', filename='js/stats.js') }}"></script>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // You can add a simple loading indicator here if you like
            const loadingEl = document.createElement('p');
            loadingEl.textContent = 'Calculating statistics...';
            document.querySelector('.hero-stats').before(loadingEl);

            const [allFlights, airportCsvText] = await Promise.all([
                getAllFlights(),
                fetch('/static/airports.csv').then(res => res.text())
            ]);

            Papa.parse(airportCsvText, {
                header: true,
                skipEmptyLines: true,
                complete: (results) => {
                    const airportData = new Map();
                    results.data.forEach(row => {
                        if (row.iata_code) {
                            airportData.set(row.iata_code, { 
                                country: row.iso_country,
                                lat: parseFloat(row.latitude_deg),
                                lng: parseFloat(row.longitude_deg)
                             });
                        }
                    });
                    
                    calculateAndDisplayStats(allFlights, airportData);
                    loadingEl.remove();
                }
            });
        });
    </script>
{% endblock %}