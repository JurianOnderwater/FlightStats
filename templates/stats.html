{% extends "base.html" %}
{% block title %}Statistics{% endblock %}

{% block content %}
    <div id="loader-container" class="loader-container">
        <md-circular-progress indeterminate></md-circular-progress>
    </div>

    <div class="stats-grid">
        <div class="stats-card">
            <h2>Distance ‚ÜîÔ∏è</h2>
            <p><strong>Total Kilometres:</strong> <span id="total-km">0</span> km</p>
            <p><strong>Total Miles:</strong> <span id="total-miles">0</span> mi</p>
            <p><strong>Earth Circumnavigations:</strong> <span id="earth-circumnavigations">0</span></p>
            <p><strong>Journey to the Moon:</strong> <span id="percent-to-moon">0</span>%</p>
        </div>
        <div class="stats-card">
            <h2>Time (Estimated) ‚è±Ô∏è</h2>
            <p><strong>Total Hours Flown:</strong> <span id="total-hours">0</span></p>
            <p><strong>Total Days Flown:</strong> <span id="total-days">0</span></p>
            <p><strong>Total Weeks Flown:</strong> <span id="total-weeks">0</span></p>
            <p><strong>Total Months Flown:</strong> <span id="total-months">0</span></p>
        </div>
        <div class="stats-card">
            <h2>Top 10 Airports üõ¨</h2>
            <ol id="top-airports-list" class="stats-list"></ol>
        </div>
        <div class="stats-card">
            <h2>Top 10 Routes üó∫Ô∏è</h2>
            <ol id="top-routes-list" class="stats-list"></ol>
        </div>
        <div class="stats-card full-width-card-left">
            <h2>Distance Milestones üèÅ</h2>
            <div class="milestones-container">
                <ul id="milestones-list" class="stats-list"></ul>
                <div class="chart-container">
                    <canvas id="distance-chart"></canvas>
                </div>
            </div>
        </div>
        <div class="stats-card full-width-card-right">
            <h2>Visited Countries üåç</h2>
            <div id="country-map"></div>
        </div>
        <div class="stats-card">
            <h2>Flights by Month üóìÔ∏è</h2>
            <div class="chart-container">
                <canvas id="seasonality-chart"></canvas>
            </div>
        </div>
        <div class="stats-card">
            <h2>Flights by Weekday üìä</h2>
            <div class="chart-container">
                <canvas id="weekday-chart"></canvas>
            </div>
        </div>
        <div class="stats-card full-width-card-right">
            <h2>Travel Distribution ‚òÄÔ∏è</h2>
            <div id="sunburst-chart" style="width: 100%; height: 600px;"></div>
        </div>

    </div>
{% endblock %}

{% block scripts %}
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="{{ url_for('static', filename='js/stats.js') }}"></script>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const loader = document.getElementById('loader-container');
            if (loader) loader.style.display = 'flex';

            try {
                const [allFlights, airportCsvText] = await Promise.all([
                    getAllFlights(),
                    fetch('/static/airports.csv').then(res => res.text())
                ]);

                Papa.parse(airportCsvText, {
                    header: true,
                    skipEmptyLines: true,
                    complete: (results) => {
                        const airportData = new Map();
                        results.data.forEach(row => {
                            if (row.iata_code) {
                                // *** THIS IS THE FIX ***
                                // Create the complete airport data object, including city and name
                                airportData.set(row.iata_code, { 
                                    name: row.name,
                                    city: row.municipality,
                                    country: row.iso_country,
                                    lat: parseFloat(row.latitude_deg),
                                    lng: parseFloat(row.longitude_deg)
                                 });
                            }
                        });
                        
                        // This function will now receive the complete data it needs
                        calculateAndDisplayStats(allFlights, airportData);
                    }
                });
            } catch (error) {
                console.error("Failed to load data for stats page:", error);
            } finally {
                if (loader) loader.style.display = 'none';
            }
        });
    </script>
{% endblock %}